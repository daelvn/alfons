<!DOCTYPE html>

<html>
<head>
  <title>[alfons](https://github.com/daelvn/alfons)</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco-nord.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">-- alfons | 02.12.2018</span>
<span class="hljs-comment">-- By daelvn</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="alfons"><a href="https://github.com/daelvn/alfons">alfons</a></h1>
<p>Project management helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>ltext = <span class="hljs-built_in">require</span> <span class="hljs-string">"ltext"</span>
file  = <span class="hljs-keyword">if</span> fs <span class="hljs-keyword">then</span> fs <span class="hljs-keyword">else</span> <span class="hljs-built_in">require</span> <span class="hljs-string">"file"</span>
ms = <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">pcall</span> -&gt;
    ms = <span class="hljs-built_in">require</span> <span class="hljs-string">"moonscript.base"</span>
  <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><strong>Alfons</strong> is a little script to aid with project management. Inspired by makefiles
(and most importantly the non-C compiling cases), it relies on exported tasks in an
Alfonsfile. You can write a very simple Alfonsfile just by writing:</p>
<pre><code class="language-moon"><span class="hljs-keyword">export</span> task = <span class="hljs-function">=&gt;</span>
  <span class="hljs-built_in">print</span> @.name</code></pre>
<p>This short thing will print “task” when we use <code>alfons task</code> to run it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">print</span> ltext.title <span class="hljs-string">"alfons 02.12.2018"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>These are the files that will be checked for when looking for readable scripts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>files = {
  <span class="hljs-string">"Alfons"</span>
  <span class="hljs-string">"alfons"</span>
  <span class="hljs-string">"Alfons.moon"</span>
  <span class="hljs-string">"Alfons.lua"</span>
  <span class="hljs-string">"alfons.lua"</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong>get_load_fn</strong> will return a load function depending on the langauge used</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_load_fn</span> = <span class="hljs-params">(f)</span> -&gt;</span>
  <span class="hljs-keyword">local</span> lf
  <span class="hljs-keyword">if</span>     f\match <span class="hljs-string">"lua"</span>  <span class="hljs-keyword">then</span> lf = <span class="hljs-built_in">loadfile</span>
  <span class="hljs-keyword">elseif</span> f\match <span class="hljs-string">"moon"</span> <span class="hljs-keyword">then</span> lf = ms.<span class="hljs-built_in">loadfile</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">local</span> content
    with <span class="hljs-built_in">io</span>.open f, <span class="hljs-string">"r"</span>
      content = \read <span class="hljs-string">"*a"</span>
      \close!

    lang = content\match <span class="hljs-string">"%-%- alfons: ?([a-z]+)"</span>
    <span class="hljs-keyword">switch</span> lang
      <span class="hljs-keyword">when</span> <span class="hljs-string">"lua"</span>  <span class="hljs-keyword">then</span> lf = <span class="hljs-built_in">loadfile</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">"moon"</span> <span class="hljs-keyword">then</span> lf = ms.<span class="hljs-built_in">loadfile</span> <span class="hljs-keyword">if</span> ms
  lf</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><strong>gen_env</strong> will generate an environment based on the version we’re running on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">gen_env</span> = <span class="hljs-params">(version)</span> -&gt;</span>
  base = {
    :<span class="hljs-built_in">_G</span>, :<span class="hljs-built_in">_VERSION</span>, :<span class="hljs-built_in">assert</span>, :<span class="hljs-built_in">collectgarbage</span>, :<span class="hljs-built_in">dofile</span>, :<span class="hljs-built_in">error</span>, :<span class="hljs-built_in">getmetatable</span>,
    :<span class="hljs-built_in">ipairs</span>, :<span class="hljs-built_in">load</span>, :<span class="hljs-built_in">loadfile</span>, :<span class="hljs-built_in">next</span>, :<span class="hljs-built_in">pairs</span>, :<span class="hljs-built_in">pcall</span>, :<span class="hljs-built_in">print</span>, :<span class="hljs-built_in">rawequal</span>,
    :<span class="hljs-built_in">rawget</span>, :<span class="hljs-built_in">rawset</span>, :<span class="hljs-built_in">require</span>, :<span class="hljs-built_in">select</span>, :<span class="hljs-built_in">setmetatable</span>, :<span class="hljs-built_in">tonumber</span>, :<span class="hljs-built_in">tostring</span>,
    :<span class="hljs-built_in">type</span>, :<span class="hljs-built_in">xpcall</span>
      
    :<span class="hljs-built_in">coroutine</span>, :<span class="hljs-built_in">debug</span>, :<span class="hljs-built_in">io</span>, :<span class="hljs-built_in">math</span>, :<span class="hljs-built_in">os</span>, :<span class="hljs-built_in">package</span>, :<span class="hljs-built_in">string</span>, :<span class="hljs-built_in">table</span>

    :<span class="hljs-built_in">_VERSION</span>
  }
  <span class="hljs-keyword">switch</span> version
    <span class="hljs-keyword">when</span> <span class="hljs-string">"lua-51"</span>
      <span class="hljs-built_in">print</span> ltext.dart <span class="hljs-string">"Generating environment for Lua 5.1 or lesser"</span>
      base.<span class="hljs-built_in">getfenv</span> = <span class="hljs-built_in">getfenv</span>
      base.<span class="hljs-built_in">setfenv</span> = <span class="hljs-built_in">setfenv</span>
      base.<span class="hljs-built_in">module</span>  = <span class="hljs-built_in">module</span>
      base.<span class="hljs-built_in">unpack</span>  = <span class="hljs-built_in">unpack</span>
    <span class="hljs-keyword">when</span> <span class="hljs-string">"lua-52"</span>
      <span class="hljs-built_in">print</span> ltext.dart <span class="hljs-string">"Generating environment for Lua 5.2"</span>
      base.rawlen   = rawlen
      base.<span class="hljs-built_in">rawequal</span> = <span class="hljs-built_in">rawequal</span>
      base.bit32    = bit32
    <span class="hljs-keyword">when</span> <span class="hljs-string">"lua-53"</span>
      <span class="hljs-built_in">print</span> ltext.dart <span class="hljs-string">"Generating environment for Lua 5.3 or greater"</span>
      base.rawlen   = rawlen
      base.<span class="hljs-built_in">rawequal</span> = <span class="hljs-built_in">rawequal</span>
      base.utf8     = utf8
  base</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong>load_alfons</strong> gets a filename and returns the tasks of the Alfonsfile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">load_alfons</span> = <span class="hljs-params">(f)</span> -&gt;</span>
  loadfn = get_load_fn f
  <span class="hljs-keyword">local</span> env, ending
  <span class="hljs-keyword">do</span>
    ending = <span class="hljs-built_in">tonumber</span> _VERSION\match <span class="hljs-string">"Lua 5.(%d)"</span>
    <span class="hljs-keyword">if</span> ending &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> env = gen_env <span class="hljs-string">"lua-51"</span>
    <span class="hljs-keyword">if</span> ending == <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> env = gen_env <span class="hljs-string">"lua-52"</span>
    <span class="hljs-keyword">if</span> ending &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> env = gen_env <span class="hljs-string">"lua-53"</span>
  
  <span class="hljs-keyword">local</span> alfons_fn
  <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> ending &lt; <span class="hljs-number">2</span>
      alfons_fn, err = loadfn f
      <span class="hljs-built_in">error</span> <span class="hljs-string">"Could not load file <span class="hljs-subst">#{f}</span>, <span class="hljs-subst">#{err}</span>"</span> <span class="hljs-keyword">if</span> err
      <span class="hljs-built_in">setfenv</span> alfons_fn, env
    <span class="hljs-keyword">else</span>
      alfons_fn, err = loadfn f, <span class="hljs-string">"t"</span>, env, {}
      <span class="hljs-built_in">error</span> <span class="hljs-string">"Could not load file <span class="hljs-subst">#{f}</span>, <span class="hljs-subst">#{err}</span>"</span> <span class="hljs-keyword">if</span> err

  <span class="hljs-built_in">print</span> ltext.dart <span class="hljs-string">"Fetching environment..."</span>
  alfons_fn!
  <span class="hljs-keyword">return</span> env</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><a name="task_kit"></a>
This small function will just let us pass the name of the task and two libraries
to the callee.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">task_kit</span> = <span class="hljs-params">(name, extra={})</span> -&gt;</span>
  extra_       = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Make a shallow copy of extra, which are the unrecognized arguments, this will be our base.
We store it in argl so not to clutter the extra table</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  extra_.argl  = {k, v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span> extra}
  extra_.name  = name
  extra_.ltext = ltext
  extra_.file  = file
  <span class="hljs-keyword">return</span> extra_</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Here, the file will be loaded and all the functions will be fetched.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">print</span> ltext.arrow <span class="hljs-string">"Finding files..."</span>
<span class="hljs-keyword">local</span> alfons
<span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> *files
  <span class="hljs-built_in">print</span> ltext.dart <span class="hljs-string">"Trying with <span class="hljs-subst">#{f}</span>"</span>
  <span class="hljs-keyword">if</span> file.exists f
    <span class="hljs-built_in">print</span> ltext.bullet <span class="hljs-string">"Found!"</span>
    alfons = load_alfons f
    <span class="hljs-keyword">break</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>We’re going to run the tasks now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">error</span> <span class="hljs-string">"Must be called from command line!"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> arg[<span class="hljs-number">0</span>]
<span class="hljs-built_in">print</span> ltext.arrow <span class="hljs-string">"Reading tasks..."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>This variable <code>extra</code> will hold our unrecognized tasks, to pass them as arguments to the next recognized task</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>extra = {}
<span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>, #arg
  <span class="hljs-built_in">print</span> ltext.bullet arg[i], <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Replace - with _</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  argx = arg[i]\gsub <span class="hljs-string">"%-"</span>, <span class="hljs-string">"_"</span>
  <span class="hljs-keyword">if</span> argx != arg[i]
    <span class="hljs-built_in">print</span> ltext.quote <span class="hljs-string">"Translating <span class="hljs-subst">#{arg[i]}</span> to <span class="hljs-subst">#{argx}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Here we can see how we use <a href="#task_kit">task_kit</a> to generate the self/@ argument </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> alfons[argx]
    <span class="hljs-built_in">print</span> ltext.bullet <span class="hljs-string">"Running!"</span>
    alfons[argx] task_kit argx, extra</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Clear extra for the next task</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    extra = {}
  <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>If it’s not recognized, then we add it to extra</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">table</span>.insert extra, argx</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><a href="https://github.com/daelvn">daelvn</a> · <a href="https://alfons.daelvn.ga">alfons</a></p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
